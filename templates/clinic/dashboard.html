{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12 text-center">
        <h2 class="text-uppercase fw-bold text-primary">Trung T√¢m ƒêi·ªÅu H√†nh B·∫£o M·∫≠t</h2>
        <p class="text-muted">H·ªá th·ªëng qu·∫£n l√Ω Y t·∫ø SecureClinic - M√£ h√≥a ƒêa l·ªõp & Ph√¢n quy·ªÅn RBAC</p>

        {% if request.session.user_role %}
        <span class="badge bg-dark">Role: {{ request.session.user_role }}</span>
        {% else %}
        <span class="badge bg-secondary">Role: User (Ch∆∞a ph√¢n quy·ªÅn)</span>
        {% endif %}
    </div>
</div>

<div class="row">
    {% if perms.can_view_salary %}
    <div class="col-lg-12 mb-4">
        <div class="card border-top border-4 border-warning shadow-sm">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-warning"><i class="fas fa-user-nurse me-2"></i>Nh√¢n S·ª± (L∆∞∆°ng AES-256)</h5>

                {% if perms.can_manage_staff %}
                <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#addStaffModal"><i
                        class="fas fa-plus"></i> Th√™m</button>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>M√£ NV</th>
                            <th>Th√¥ng Tin</th>
                            <th>L∆∞∆°ng (AES Oracle)</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for nv in nhanviens %}
                        <tr>
                            <td><strong>{{ nv.manv }}</strong></td>
                            <td>{{ nv.hoten }}<br><small class="text-muted">{{ nv.chucvu }}</small></td>
                            <td style="max-width: 200px;">
                                <span id="sal-{{ nv.manv }}" class="text-muted small text-truncate d-block"
                                    data-state="enc">{{ nv.luong_enc }}</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary"
                                    onclick="toggleDecrypt('{{ nv.manv }}', '{{ nv.luong_enc }}', 'salary')"><i
                                        class="fas fa-eye"></i></button>

                                {% if perms.can_manage_staff %}
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                                    data-bs-target="#editStaffModal{{ nv.manv }}"><i class="fas fa-edit"></i></button>

                                {% if request.session.db_user == 'CLINIC_ADMIN' %}
                                <a href="{% url 'delete_staff' nv.manv %}" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('X√≥a?');"><i class="fas fa-trash"></i></a>
                                {% endif %}
                                {% endif %}
                            </td>
                        </tr>

                        {% if perms.can_manage_staff %}
                        <div class="modal fade" id="editStaffModal{{ nv.manv }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{% url 'edit_staff' nv.manv %}" method="POST">
                                        {% csrf_token %}
                                        <div class="modal-header bg-warning">
                                            <h5 class="modal-title">S·ª≠a: {{ nv.hoten }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-2">
                                                <label>H·ªç T√™n</label>
                                                <input type="text" name="hoten" class="form-control"
                                                    value="{{ nv.hoten }}" required>
                                            </div>
                                            <div class="mb-2">
                                                <label>Email</label>
                                                <input type="email" name="email" class="form-control"
                                                    value="{{ nv.email }}" required>
                                            </div>
                                            <div class="mb-2">
                                                <label>Ch·ª©c V·ª•</label>
                                                <select name="chucvu" class="form-select">
                                                    <option value="BacSi" {% if nv.is_bacsi %}selected{% endif %}>B√°c Sƒ©
                                                    </option>
                                                    <option value="YTa" {% if nv.is_yta %}selected{% endif %}>Y T√°
                                                    </option>
                                                    <option value="LeTan" {% if nv.is_letan %}selected{% endif %}>L·ªÖ T√¢n
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label class="text-danger fw-bold">L∆∞∆°ng M·ªõi (Auto Encrypt)</label>
                                                <input type="number" name="luong" class="form-control border-danger"
                                                    placeholder="Nh·∫≠p l∆∞∆°ng m·ªõi..." required>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">L∆∞u</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="col-lg-12 mb-4">
        <div class="card border-top border-4 border-success shadow-sm">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-success"><i class="fas fa-procedures me-2"></i>B·ªánh Nh√¢n (RSA DB)</h5>
                {% if not perms.is_ketoan %}
                <button class="btn btn-success btn-sm fw-bold" data-bs-toggle="modal"
                    data-bs-target="#addCustomerModal"><i class="fas fa-plus"></i> Th√™m</button>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>M√£ KH</th>
                            <th>Th√¥ng Tin</th>
                            <th>B·ªánh √Ån (RSA Oracle)</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for kh in khachhangs %}
                        <tr>
                            <td><strong>{{ kh.makh }}</strong></td>
                            <td>{{ kh.hoten }}<br><small class="text-muted">{{ kh.sdt }}</small></td>
                            <td style="max-width: 200px;">
                                {% if perms.can_view_medical %}
                                <span id="med-{{ kh.makh }}" class="text-muted small text-truncate d-block"
                                    data-state="enc">{{ kh.benhan_enc }}</span>
                                {% else %}
                                <span class="badge bg-secondary">B·ªã ·∫©n (Kh√¥ng c√≥ quy·ªÅn)</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if perms.can_view_medical %}
                                <button class="btn btn-sm btn-outline-success"
                                    onclick="toggleDecrypt('{{ kh.makh }}', '{{ kh.benhan_enc }}', 'medical')"><i
                                        class="fas fa-lock"></i></button>
                                {% endif %}

                                {% if not perms.is_ketoan %}
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                                    data-bs-target="#editCustomerModal{{ kh.makh }}"><i
                                        class="fas fa-edit"></i></button>
                                <a href="{% url 'delete_customer' kh.makh %}" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('X√≥a?');"><i class="fas fa-trash"></i></a>
                                {% endif %}
                            </td>
                        </tr>

                        <div class="modal fade" id="editCustomerModal{{ kh.makh }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{% url 'edit_customer' kh.makh %}" method="POST">
                                        {% csrf_token %}
                                        <div class="modal-header bg-success text-white">
                                            <h5 class="modal-title">S·ª≠a: {{ kh.hoten }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-2">
                                                <label>H·ªç T√™n</label>
                                                <input type="text" name="hoten" class="form-control"
                                                    value="{{ kh.hoten }}" required>
                                            </div>
                                            <div class="mb-2">
                                                <label>SƒêT</label>
                                                <input type="text" name="sdt" class="form-control" value="{{ kh.sdt }}"
                                                    required>
                                            </div>
                                            <div class="mb-2">
                                                <label class="text-danger fw-bold">B·ªánh √Ån M·ªõi (Auto RSA
                                                    Encrypt)</label>
                                                <textarea name="benhan" class="form-control border-danger" required
                                                    placeholder="Nh·∫≠p b·ªánh √°n m·ªõi..."></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-success">L∆∞u</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card border-top border-4 border-info shadow-sm h-100">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-info"><i class="fas fa-calendar-alt me-2"></i>L·ªãch H·∫πn (AES App)</h5>
                {% if perms.can_add_appt %}
                <button class="btn btn-info btn-sm text-white fw-bold" data-bs-toggle="modal"
                    data-bs-target="#addApptModal"><i class="fas fa-plus"></i></button>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>M√£</th>
                            <th>Chi Ti·∫øt</th>
                            <th>Ghi Ch√∫</th>
                            <th>X·ª≠ L√Ω</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lh in lichhens %}
                        <tr>
                            <td>{{ lh.ma_lh }}</td>
                            <td><small>{{ lh.kh_ten }}<br>{{ lh.ngay_hen|date:"d/m/Y" }}</small></td>
                            <td style="max-width: 100px;">
                                <span id="appt-{{ lh.ma_lh }}" class="text-muted small text-truncate d-block"
                                    data-state="enc">{{ lh.ghi_chu_enc }}</span>
                            </td>
                            <td>
                                <a href="javascript:void(0)"
                                    onclick="apiDecrypt('appt', '{{ lh.ma_lh }}', '{{ lh.ghi_chu_enc }}')">üëÅÔ∏è</a>
                                {% if not perms.is_ketoan %}
                                <a href="javascript:void(0)" data-bs-toggle="modal"
                                    data-bs-target="#editApptModal{{ lh.ma_lh }}" class="text-secondary mx-1"><i
                                        class="fas fa-edit"></i></a>
                                <a href="{% url 'delete_appointment' lh.ma_lh %}" class="text-danger"
                                    onclick="return confirm('X√≥a?');"><i class="fas fa-trash"></i></a>
                                {% endif %}
                            </td>
                        </tr>
                        <div class="modal fade" id="editApptModal{{ lh.ma_lh }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{% url 'edit_appointment' lh.ma_lh %}" method="POST">{% csrf_token %}
                                        <div class="modal-header bg-info text-white">
                                            <h5 class="modal-title">S·ª≠a L·ªãch: {{ lh.ma_lh }}</h5><button type="button"
                                                class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body"><label>Ng√†y H·∫πn M·ªõi</label><input type="date"
                                                name="ngay_hen" class="form-control mb-2" required><label
                                                class="text-danger">Ghi Ch√∫ M·ªõi (Auto AES App)</label><textarea
                                                name="ghi_chu" class="form-control border-info" required></textarea>
                                        </div>
                                        <div class="modal-footer"><button type="submit"
                                                class="btn btn-info text-white">L∆∞u</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if perms.can_view_medical %}
    <div class="col-lg-6 mb-4">
        <div class="card border-top border-4 border-danger shadow-sm h-100">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-danger"><i class="fas fa-file-medical-alt me-2"></i>H·ªì S∆° (Hybrid)</h5>
                {% if perms.is_bacsi or perms.is_admin %}
                <button class="btn btn-danger btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#addRecordModal"><i
                        class="fas fa-plus"></i></button>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>M√£</th>
                            <th>BN</th>
                            <th>Ch·∫©n ƒêo√°n</th>
                            <th>X·ª≠ L√Ω</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hs in hosos %}
                        <tr>
                            <td>{{ hs.ma_hs }}</td>
                            <td><small>{{ hs.kh_ten }}<br>{{ hs.ngay|date:"d/m" }}</small></td>
                            <td style="max-width: 100px;">
                                <span id="rec-{{ hs.ma_hs }}" class="text-muted small text-truncate d-block"
                                    data-state="enc">{{ hs.chan_doan_enc }}</span>
                            </td>
                            <td>
                                <a href="javascript:void(0)" onclick="apiDecrypt('record', '{{ hs.ma_hs }}', '')">üîê</a>
                                {% if perms.is_bacsi or perms.is_admin %}
                                <a href="javascript:void(0)" data-bs-toggle="modal"
                                    data-bs-target="#editRecordModal{{ hs.ma_hs }}" class="text-secondary mx-1"><i
                                        class="fas fa-edit"></i></a>
                                <a href="{% url 'delete_record' hs.ma_hs %}" class="text-danger"
                                    onclick="return confirm('X√≥a?');"><i class="fas fa-trash"></i></a>
                                {% endif %}
                            </td>
                        </tr>
                        <div class="modal fade" id="editRecordModal{{ hs.ma_hs }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{% url 'edit_record' hs.ma_hs %}" method="POST">{% csrf_token %}<div
                                            class="modal-header bg-danger text-white">
                                            <h5 class="modal-title">S·ª≠a H·ªì S∆°: {{ hs.ma_hs }}</h5><button type="button"
                                                class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body"><label class="text-danger">Ch·∫©n ƒêo√°n M·ªõi (Auto
                                                Hybrid)</label><textarea name="chan_doan"
                                                class="form-control border-danger" rows="4" required></textarea></div>
                                        <div class="modal-footer"><button type="submit"
                                                class="btn btn-danger">L∆∞u</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% if perms.can_view_opinion %}
    <div class="col-lg-12 mb-4">
        <div class="card border-top border-4 border-dark shadow-sm">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <h5 class="m-0 fw-bold text-dark"><i class="fas fa-user-secret me-2"></i>√ù Ki·∫øn Ri√™ng (RSA App Direct)
                </h5>
                {% if perms.is_bacsi or perms.is_admin %}
                <button class="btn btn-dark btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#addOpinionModal"><i
                        class="fas fa-plus"></i> Th√™m √ù Ki·∫øn</button>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>M√£ YK</th>
                            <th>T·ª´ BS -> BN</th>
                            <th>N·ªôi Dung (RSA Tr·ª±c ti·∫øp)</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for yk in ykiens %}
                        <tr>
                            <td>{{ yk.ma_yk }}</td>
                            <td><small>{{ yk.bs_ten }} <i class="fas fa-arrow-right"></i> {{ yk.kh_ten }}</small></td>
                            <td style="max-width: 300px;">
                                <span id="op-{{ yk.ma_yk }}" class="text-muted small text-truncate d-block"
                                    data-state="enc">{{ yk.noi_dung_enc }}</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-dark"
                                    onclick="apiDecrypt('opinion', '{{ yk.ma_yk }}', '{{ yk.noi_dung_enc }}')"><i
                                        class="fas fa-key"></i></button>
                                {% if perms.is_bacsi or perms.is_admin %}
                                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                                    data-bs-target="#editOpinionModal{{ yk.ma_yk }}"><i
                                        class="fas fa-edit"></i></button>
                                <a href="{% url 'delete_opinion' yk.ma_yk %}" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('X√≥a?');"><i class="fas fa-trash"></i></a>
                                {% endif %}
                            </td>
                        </tr>
                        <div class="modal fade" id="editOpinionModal{{ yk.ma_yk }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{% url 'edit_opinion' yk.ma_yk %}" method="POST">{% csrf_token %}<div
                                            class="modal-header bg-dark text-white">
                                            <h5 class="modal-title">S·ª≠a √ù Ki·∫øn: {{ yk.ma_yk }}</h5><button type="button"
                                                class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body"><label class="fw-bold">N·ªôi Dung M·ªõi</label><textarea
                                                name="noi_dung" class="form-control border-dark" rows="3" required
                                                placeholder="Nh·∫≠p n·ªôi dung s·ª≠a ƒë·ªïi (Auto RSA Encrypt)..."></textarea>
                                        </div>
                                        <div class="modal-footer"><button type="submit" class="btn btn-dark">L∆∞u Thay
                                                ƒê·ªïi</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="addStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'add_staff' %}" method="POST">{% csrf_token %}<div class="modal-header bg-warning">
                    <h5 class="modal-title">Th√™m Nh√¢n Vi√™n M·ªõi</h5>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-6"><input type="text" name="manv" class="form-control mb-2" placeholder="M√£ NV"
                                required></div>
                        <div class="col-6"><input type="text" name="cccd" class="form-control mb-2" placeholder="CCCD"
                                required></div>
                    </div><input type="text" name="hoten" class="form-control mb-2" placeholder="H·ªç T√™n" required><input
                        type="email" name="email" class="form-control mb-2" placeholder="Email" required><select
                        name="chucvu" class="form-select mb-2">
                        <option value="BacSi">B√°c Sƒ©</option>
                        <option value="YTa">Y T√°</option>
                        <option value="LeTan">L·ªÖ T√¢n</option>
                    </select>
                    <div class="mb-2"><label class="text-danger fw-bold">L∆∞∆°ng (S·∫Ω Auto Encrypt AES)</label><input
                            type="number" name="luong" class="form-control border-danger" required></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Th√™m M·ªõi</button></div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'add_customer' %}" method="POST">
                {% csrf_token %}
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Th√™m H·ªì S∆° B·ªánh √Ån & G√°n Nh√£n</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label>M√£ KH</label>
                        <input type="text" name="makh" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label>H·ªç T√™n</label>
                        <input type="text" name="hoten" class="form-control" required>
                    </div>

                    <div class="mb-2">
                        <label class="fw-bold text-primary"><i class="fas fa-tag"></i> Nh√£n B·∫£o M·∫≠t (OLS)</label>
                        <select name="ols_label" class="form-select border-primary">
                            <option value="PUB">-- B√¨nh Th∆∞·ªùng (Public) --</option>
                            <option value="CONF">‚≠ê‚≠ê‚≠ê VIP (B·∫£o M·∫≠t Cao) ‚≠ê‚≠ê‚≠ê</option>
                        </select>
                        <small class="text-muted">VIP: Ch·ªâ B√°c sƒ© Tr∆∞·ªüng m·ªõi th·∫•y. Th∆∞·ªùng: Ai c≈©ng th·∫•y.</small>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-2"><label>Ng√†y Sinh</label><input type="date" name="ngaysinh"
                                class="form-control" required></div>
                        <div class="col-6 mb-2"><label>SƒêT</label><input type="text" name="sdt" class="form-control"
                                required></div>
                    </div>
                    <div class="mb-2">
                        <label class="text-danger fw-bold">B·ªánh √Ån (S·∫Ω Auto Encrypt RSA)</label>
                        <textarea name="benhan" class="form-control border-danger" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">L∆∞u H·ªì S∆°</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="addApptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'add_appointment' %}" method="POST">{% csrf_token %}<div
                    class="modal-header bg-info text-white">
                    <h5 class="modal-title">Th√™m L·ªãch H·∫πn</h5>
                </div>
                <div class="modal-body"><input type="text" name="ma_lh" class="form-control mb-2" placeholder="M√£ LH"
                        required><select name="ma_kh" class="form-select mb-2">{% for kh in khachhangs %}<option
                            value="{{ kh.makh }}">{{ kh.hoten }}</option>{% endfor %}</select><select name="manv"
                        class="form-select mb-2">{% for nv in nhanviens %}<option value="{{ nv.manv }}">{{ nv.hoten }}
                        </option>{% endfor %}</select><input type="date" name="ngay_hen" class="form-control mb-2"
                        required><textarea name="ghi_chu" class="form-control border-info"
                        placeholder="Ghi ch√∫ (AES App)..." required></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-info text-white">Th√™m</button></div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="addRecordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'add_record' %}" method="POST">{% csrf_token %}<div
                    class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Th√™m H·ªì S∆°</h5>
                </div>
                <div class="modal-body"><input type="text" name="ma_hs" class="form-control mb-2" placeholder="M√£ HS"
                        required><select name="ma_kh" class="form-select mb-2">{% for kh in khachhangs %}<option
                            value="{{ kh.makh }}">{{ kh.hoten }}</option>{% endfor %}</select><textarea name="chan_doan"
                        class="form-control border-danger" placeholder="Ch·∫©n ƒëo√°n (Hybrid)..." required
                        rows="4"></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-danger">Th√™m</button></div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="addOpinionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'add_opinion' %}" method="POST">{% csrf_token %}<div
                    class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Th√™m √ù Ki·∫øn Ri√™ng</h5>
                </div>
                <div class="modal-body"><input type="text" name="ma_yk" class="form-control mb-2" placeholder="M√£ YK"
                        required><select name="manv" class="form-select mb-2">{% for nv in nhanviens %}<option
                            value="{{ nv.manv }}">{{ nv.hoten }} (BS)</option>{% endfor %}</select><select name="ma_kh"
                        class="form-select mb-2">{% for kh in khachhangs %}<option value="{{ kh.makh }}">{{ kh.hoten }}
                            (BN)</option>{% endfor %}</select><textarea name="noi_dung" class="form-control border-dark"
                        placeholder="N·ªôi dung m·∫≠t (RSA App Direct)..." required rows="3"></textarea></div>
                <div class="modal-footer"><button type="submit" class="btn btn-dark">Th√™m</button></div>
            </form>
        </div>
    </div>
</div>

<script>
    // H√†m gi·∫£i m√£ chung cho DB
    function toggleDecrypt(id, val, type) {
        let spanId = (type === 'salary') ? `sal-${id}` : `med-${id}`;
        let span = document.getElementById(spanId);
        let url = (type === 'salary') ? `/api/decrypt-salary/?val=${encodeURIComponent(val)}` : `/api/decrypt-medical/?val=${encodeURIComponent(val)}`;

        if (span.getAttribute('data-state') === 'enc') {
            span.innerHTML = '...';
            fetch(url).then(r => r.json()).then(d => {
                span.innerText = d.decrypted;
                span.setAttribute('data-state', 'dec');
                span.classList.add('fw-bold', (type === 'salary' ? 'text-success' : 'text-danger'));
            });
        } else {
            span.innerText = val;
            span.setAttribute('data-state', 'enc');
            span.classList.remove('fw-bold', 'text-success', 'text-danger');
        }
    }

    // H√†m gi·∫£i m√£ cho App (AES, Hybrid, RSA App)
    function apiDecrypt(type, id, val) {
        let spanId = '', url = '', colorClass = '';

        if (type === 'appt') { spanId = `appt-${id}`; url = `/api/decrypt-appt/?val=${encodeURIComponent(val)}`; colorClass = 'text-info'; }
        else if (type === 'record') { spanId = `rec-${id}`; url = `/api/decrypt-record/?id=${id}`; colorClass = 'text-danger'; }
        else if (type === 'opinion') { spanId = `op-${id}`; url = `/api/decrypt-opinion/?val=${encodeURIComponent(val)}`; colorClass = 'text-dark'; }

        let span = document.getElementById(spanId);

        if (span.getAttribute('data-state') === 'enc') {
            span.innerHTML = '...';
            fetch(url).then(r => r.json()).then(d => {
                span.innerText = d.decrypted;
                span.setAttribute('data-state', 'dec');
                span.classList.add('fw-bold', colorClass);
            });
        } else {
            if (type === 'record') span.innerText = "(ƒê√£ ·∫©n)";
            else span.innerText = val;
            span.setAttribute('data-state', 'enc');
            span.classList.remove('fw-bold', colorClass);
        }
    }
</script>
{% endblock %}